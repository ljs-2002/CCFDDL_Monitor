name: CCF Deadline Monitor

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 07:00 (UTC 23:00) è¿è¡Œ
    - cron: '0 23 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      conference_name:
        description: 'è¯·è¾“å…¥è¦æŸ¥è¯¢çš„ä¼šè®®ç®€ç§° (ä¸ºç©ºåˆ™æ‰§è¡Œæ—¥å¸¸å¢é‡æ›´æ–°)'
        required: false
        default: ''
  discussion:
    types: [created]

permissions:
  contents: write
  discussions: read
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code Repo
        uses: actions/checkout@v4
        with:
          path: '.'

      # 2. æ£€å‡ºç§æœ‰æ•°æ®ä»“åº“åˆ° data ç›®å½•
      - name: Checkout Private Data Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.DATA_REPO }}
          token: ${{ secrets.DATA_REPO_TOKEN }}
          path: 'data' # å…³é”®ï¼šç›´æ¥æ˜ å°„åˆ°è„šæœ¬éœ€è¦çš„ data æ–‡ä»¶å¤¹                     # é‡ç‚¹ï¼šç›´æ¥æ‹‰å–åˆ°ä»£ç ä»“çš„ data ç›®å½•ä¸‹

      - name: Checkout CCF-Deadlines Source
        uses: actions/checkout@v4
        with:
          repository: 'ccfddl/ccf-deadlines'
          path: 'ccf-repo'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Monitor Script
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          USE_LLM: ${{ secrets.USE_LLM }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          INTERESTED_AREAS: ${{ secrets.INTERESTED_AREAS }}
          MAX_PAPERS_PER_YEAR: ${{ secrets.MAX_PAPERS_PER_YEAR }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          # è·å–è§¦å‘è€…çš„ç”¨æˆ·åå’Œè®¨è®ºåˆ†ç±»åç§°
          AUTHOR="${{ github.event.discussion.user.login }}"
          CATEGORY="${{ github.event.discussion.category.name }}"
          OWNER="${{ github.repository_owner }}"

          # é€»è¾‘åˆ¤æ–­ï¼š
          # 1. å¦‚æœæ˜¯è®¨è®ºåŒºè§¦å‘
          if [[ "${{ github.event_name }}" == "discussion" ]]; then
            TITLE="${{ github.event.discussion.title }}"
            
            # å®‰å…¨åŒé‡è¿‡æ»¤ï¼šå¿…é¡»æ˜¯ Query åˆ†ç±» ä¸” å¿…é¡»æ˜¯ä½œè€…æœ¬äºº
            if [[ "$CATEGORY" == "Query" ]] && [[ "$AUTHOR" == "$OWNER" ]]; then
              if [[ "$TITLE" == q:* ]]; then
                KEYWORD=$(echo "$TITLE" | sed 's/q://g' | xargs)
                python -u query.py --query "$KEYWORD"

              elif [[ "$TITLE" == qn:* ]]; then
                # å¿«é€ŸæŸ¥è¯¢ï¼šç¦ç”¨ LLM
                # åœ¨å‘½ä»¤å‰åŠ  USE_LLM=False ä¼šä»…é’ˆå¯¹æœ¬æ¬¡è¿›ç¨‹è¦†ç›–ç¯å¢ƒå˜é‡
                KEYWORD=$(echo "$TITLE" | sed 's/qn://g' | xargs)
                echo "âš¡ æ‰§è¡Œå¿«é€ŸæŸ¥è¯¢ (ç¦ç”¨ LLM): $KEYWORD"
                USE_LLM=False python -u query.py --query "$KEYWORD"
              fi
            else
              echo "ğŸ›¡ï¸ æ‹¦æˆªï¼šéä½œè€…æœ¬äººæˆ–é Query åˆ†ç±»çš„éæ³•è¯·æ±‚ (Author: $AUTHOR, Category: $CATEGORY)"
              exit 0
            fi
          
          # 2. æ‰‹åŠ¨æŒ‰é’®è§¦å‘
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            CONF_NAME="${{ github.event.inputs.conference_name }}"
            if [[ -n "$CONF_NAME" ]]; then
              echo "ğŸ” æ‰‹åŠ¨æŸ¥è¯¢ä¼šè®®: $CONF_NAME"
              python -u query.py --query "$CONF_NAME"
            else
              python -u query.py
            fi
          
          # 3. å®šæ—¶ä»»åŠ¡
          else
            python -u query.py
          fi

      - name: Push Changes to Private Data Repo
        working-directory: 'data' # åªåœ¨ data æ–‡ä»¶å¤¹å†…æ“ä½œ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Update Knowledge Base [skip ci]" || echo "No changes to commit"
          # ä½¿ç”¨ Token å¼ºåˆ¶æ¨é€å›ç§æœ‰åº“
          git push "https://x-access-token:${{ secrets.DATA_REPO_TOKEN }}@github.com/${{ secrets.DATA_REPO }}.git" HEAD:main
      
      - name: Cleanup old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
        # åªä¿ç•™æœ€è¿‘ 6 æ¬¡æˆåŠŸçš„è®°å½•ï¼Œåˆ é™¤å…¶ä½™æˆåŠŸçš„ï¼Œä¿æŒåˆ—è¡¨æ¸…çˆ½
        run: |
          gh run list --workflow "${{ github.workflow }}" --status success --limit 100 --json databaseId \
            | jq -r '.[6:] | .[].databaseId' \
            | xargs -r -I{} gh run delete {} || echo "No runs to delete"