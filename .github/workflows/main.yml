name: CCF Deadline Monitor

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 07:00 (UTC 23:00) è¿è¡Œ
    - cron: '0 23 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  discussion:
    types: [created]

permissions:
  contents: write
  discussions: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Search Repo
        uses: actions/checkout@v4
        with:
          path: '.'

      - name: Checkout CCF-Deadlines Source
        uses: actions/checkout@v4
        with:
          repository: 'ccfddl/ccf-deadlines'
          path: 'ccf-repo'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Monitor Script
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          INTERESTED_AREAS: ${{ secrets.INTERESTED_AREAS }}
          MAX_PAPERS_PER_YEAR: ${{ secrets.MAX_PAPERS_PER_YEAR }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
        run: |
          # è·å–è§¦å‘è€…çš„ç”¨æˆ·åå’Œè®¨è®ºåˆ†ç±»åç§°
          AUTHOR="${{ github.event.discussion.user.login }}"
          CATEGORY="${{ github.event.discussion.category.name }}"
          OWNER="${{ github.repository_owner }}"

          # é€»è¾‘åˆ¤æ–­ï¼š
          # 1. å¦‚æœæ˜¯è®¨è®ºåŒºè§¦å‘
          if [[ "${{ github.event_name }}" == "discussion" ]]; then
            TITLE="${{ github.event.discussion.title }}"
            
            # å®‰å…¨åŒé‡è¿‡æ»¤ï¼šå¿…é¡»æ˜¯ Query åˆ†ç±» ä¸” å¿…é¡»æ˜¯ä½œè€…æœ¬äºº
            if [[ "$CATEGORY" == "Query" ]] && [[ "$AUTHOR" == "$OWNER" ]]; then
              if [[ "$TITLE" == q:* ]]; then
                KEYWORD=$(echo "$TITLE" | sed 's/q://g' | xargs)
                python -u query.py --query "$KEYWORD"
              fi  
            else
              echo "ğŸ›¡ï¸ æ‹¦æˆªï¼šéä½œè€…æœ¬äººæˆ–é Query åˆ†ç±»çš„éæ³•è¯·æ±‚ (Author: $AUTHOR, Category: $CATEGORY)"
              exit 0
            fi
          
          # 2. æ‰‹åŠ¨æŒ‰é’®è§¦å‘
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event_inputs.conference_name }}" != "" ]]; then
              python query.py --query "${{ github.event.inputs.conference_name }}"
            else
              python -u query.py
            fi
          
          # 3. å®šæ—¶ä»»åŠ¡
          else
            python -u query.py
          fi

      - name: Commit and Push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -f data/
          git commit -m "Update CCF state and knowledge base [skip ci]" || echo "No changes to commit"
          git pull --rebase origin main
          git push